---
title: "Project"
author: "Santosh Reddy Edulapalle"
date: "2022-11-07"
output: html_document
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

We will use this markdown file to code our project and write any relevant updates.
```{r}
print("Hello World!")
```





$\textbf{Loading datasets}$

```{r}
df.rice.farm.harvest.price <- read.csv("/Users/santosh/Documents/CSP571/CSP571-DPA/Datasets/Rice_farm_harvest_price.csv")


df.rice.area.production.yield <- read.csv("/Users/santosh/Documents/CSP571/CSP571-DPA/Datasets/Rice_area_production_yield.csv")


df.irrigation.sourcewise.irrigated.area <- read.csv("/Users/santosh/Documents/CSP571/CSP571-DPA/Datasets/Irrigation_sourcewise_irrigated_area.csv")


df.irrigation.rice.area <- read.csv("/Users/santosh/Documents/CSP571/CSP571-DPA/Datasets/Irrigation_rice_area.csv")


df.inputs.wages <- read.csv("/Users/santosh/Documents/CSP571/CSP571-DPA/Datasets/Inputs_wages.csv")


df.inputs.season.fertilizer.consumption <- read.csv("/Users/santosh/Documents/CSP571/CSP571-DPA/Datasets/Inputs_season_fertilizer_consumption.csv")


df.inputs.fertilizer.consumption <- read.csv("/Users/santosh/Documents/CSP571/CSP571-DPA/Datasets/Inputs_fertilizer_consumption.csv")

df.environment.temperature.minimum <- read.csv("/Users/santosh/Documents/CSP571/CSP571-DPA/Datasets/Environment_temperature_minimum*.csv")

df.environment.temperature.maximum <- read.csv("/Users/santosh/Documents/CSP571/CSP571-DPA/Datasets/Environment_temperature_maximum*.csv")

df.environment.precipitation <- read.csv("/Users/santosh/Documents/CSP571/CSP571-DPA/Datasets/Environment_precipitation*.csv")

df.environment.evapotranspiration.potential <- read.csv("/Users/santosh/Documents/CSP571/CSP571-DPA/Datasets/Environment_evapotranspiration_potential*.csv")

df.environment.evapotranspiration.actual <- read.csv("/Users/santosh/Documents/CSP571/CSP571-DPA/Datasets/Environment_evapotranspiration_actual*.csv")

df.biophysical.soil.type1 <- read.csv("/Users/santosh/Documents/CSP571/CSP571-DPA/Datasets/Biophysical_soil_type1.csv")

df.biophysical.monthly.rainfall <- read.csv("/Users/santosh/Documents/CSP571/CSP571-DPA/Datasets/Biophysical_monthly_rainfall.csv")

df.biophysical.length.of.growing.period <- read.csv("/Users/santosh/Documents/CSP571/CSP571-DPA/Datasets/Biophysical_length_of_growing_period.csv")

df.biophysical.landuse <- read.csv("/Users/santosh/Documents/CSP571/CSP571-DPA/Datasets/Biophysical_landuse.csv")


```

$\textbf{Handling missing values.}$

(In the ICRISAT website, we are said that missing values are coded as -1).
As we can see, there are missing values in few columns. They are:
df.rice.farm.harvest.price$PADDY.HARVEST.PRICE..Rs.per.Quintal.
df.inputs.fertilizer.consumption$TOTAL.PER.HA.OF.NCA..Kg.per.ha. -> (West Godavari 1966,1967. This enire row in the data frame - df.inputs.fertilizer.consumption is not provided. So we can delete this. )
df.inputs.season.fertilizer.consumption$NITROGEN.KHARIF.CONSUMPTION..tons. -> (All the column values of these given districts is missing for these two particular years - 1998,1999 Srikakulam,
Vishakapatnam, East Godavari, West Godavari, Krishna, Guntur, S.P.S.Nellore, Kurnool, Ananthapur, Kadapa YSR, Chitoor, )
df.inputs.wages --> There are 132 missing values. (almost 25% data is missing)

So Now, we decided to delete these missing value rows.



```{r}

df.rice.farm.harvest.price <- df.rice.farm.harvest.price[df.rice.farm.harvest.price$PADDY.HARVEST.PRICE..Rs.per.Quintal. != -1,]
df.inputs.fertilizer.consumption <- df.inputs.fertilizer.consumption[df.inputs.fertilizer.consumption$NITROGEN.SHARE.IN.NPK..Percent. != -1,]

df.inputs.season.fertilizer.consumption <- 
  df.inputs.season.fertilizer.consumption[df.inputs.season.fertilizer.consumption$NITROGEN.KHARIF.CONSUMPTION..tons. != -1,]

df.inputs.wages <- df.inputs.wages[df.inputs.wages$DISTRICT.FEMALE.FIELD.LABOUR..Rs.per.Day. != -1,]

df.inputs.wages <- df.inputs.wages[df.inputs.wages$DISTRICT.MALE.FIELD.LABOUR..Rs.per.Day. != -1,]


# count1 <- ifelse(df.rice.farm.harvest.price$PADDY.HARVEST.PRICE..Rs.per.Quintal. == -1,1,0)
# count2 <- ifelse(df.inputs.fertilizer.consumption$TOTAL.PER.HA.OF.GCA..Kg.per.ha. == -1,1,0)
# count3 <- ifelse(df.inputs.season.fertilizer.consumption$NITROGEN.KHARIF.CONSUMPTION..tons. == -1,1,0)
# count4 <- ifelse(df.inputs.wages$DISTRICT.FEMALE.FIELD.LABOUR..Rs.per.Day. == -1,1,0)
# count5 <- ifelse(df.inputs.wages$DISTRICT.MALE.FIELD.LABOUR..Rs.per.Day. == -1,1,0)
# count6 <- ifelse(df.inputs.wages$STATE.MALE.AVERAGE.FIELD.LABOUR..Rs.per.Day. == -1,1,0)
# 
# 
# sum(count1)
# sum(count2)
# sum(count3)
# sum(count4)
# sum(count5)
# sum(count6)
# sum(count7)


```


Since there are many columns in dataset, we like to reduce some redundant columns by talking average of months by general agricultural seasons in India.
Kharif - July - October.
Rabi - November - April
Zaid - March - June

But now for analysis reasons, we consider Rabi to be only November to February.


```{r}
#calculating means 
#df.biophysical.monthly.rainfall
df.biophysical.monthly.rainfall$Zaid.rainfall.mm <- rowMeans(df.biophysical.monthly.rainfall[,c("MARCH.RAINFALL..Millimeters.","APRIL.RAINFALL..Millimeters.","MAY.RAINFALL..Millimeters.","JUNE.RAINFALL..Millimeters.")])
df.biophysical.monthly.rainfall$Kharif.rainfall.mm <- rowMeans(df.biophysical.monthly.rainfall[,c("JULY.RAINFALL..Millimeters.","AUGUST.RAINFALL..Millimeters.","SEPTEMBER.RAINFALL..Millimeters.","OCTOBER.RAINFALL..Millimeters.")])
df.biophysical.monthly.rainfall$Rabi.rainfall.mm <- rowMeans(df.biophysical.monthly.rainfall[,c("NOVEMBER.RAINFALL..Millimeters.","DECEMBER.RAINFALL..Millimeters.","JANUARY.RAINFALL..Millimeters.","FEBRUARY.RAINFALL..Millimeters.")])

#df.environment.evapotranspiration.actual
df.environment.evapotranspiration.actual$Zaid.evapotranspiration.actual.mm<-
  rowMeans(df.environment.evapotranspiration.actual[,c("MARCH.ACTUAL..Millimeters.","APRIL.ACTUAL..Millimeters.","MAY.ACTUAL..Millimeters.","JUNE.ACTUAL..Millimeters.")])
df.environment.evapotranspiration.actual$Kharif.evapotranspiration.actual.mm<-
  rowMeans(df.environment.evapotranspiration.actual[,c("JULY.ACTUAL..Millimeters.","AUGUST.ACTUAL..Millimeters.","SEPTEMBER.ACTUAL..Millimeters.","OCTOBER.ACTUAL..Millimeters.")])
df.environment.evapotranspiration.actual$Rabi.evapotranspiration.actual.mm<-
  rowMeans(df.environment.evapotranspiration.actual[,c("NOVEMBER.ACTUAL..Millimeters.","DECEMBER.ACTUAL..Millimeters.","JANUARY.ACTUAL..Millimeters.","FEBRUARY.ACTUAL..Millimeters.")])


#df.environment.evapotranspiration.potential
df.environment.evapotranspiration.potential$Zaid.evapotranspiration.potential.mm<-
  rowMeans(df.environment.evapotranspiration.potential[,c("MARCH.POTENTIAL..Millimeters.","APRIL.POTENTIAL..Millimeters.","MAY.POTENTIAL..Millimeters.","JUNE.POTENTIAL..Millimeters.")])
df.environment.evapotranspiration.potential$Kharif.evapotranspiration.potential.mm<-
  rowMeans(df.environment.evapotranspiration.potential[,c("JULY.POTENTIAL..Millimeters.","AUGUST.POTENTIAL..Millimeters.","SEPTEMBER.POTENTIAL..Millimeters.","OCTOBER.POTENTIAL..Millimeters.")])
df.environment.evapotranspiration.potential$Rabi.evapotranspiration.potential.mm<-
  rowMeans(df.environment.evapotranspiration.potential[,c("NOVEMBER.POTENTIAL..Millimeters.","DECEMBER.POTENTIAL..Millimeters.","JANUARY.POTENTIAL..Millimeters.","FEBRUARY.POTENTIAL..Millimeters.")])

#df.environment.precipitation
df.environment.precipitation$Zaid.percipitation.mm <- rowMeans( df.environment.precipitation[,c("MARCH.PERCIPITATION..Millimeters.","APRIL.PERCIPITATION..Millimeters.","MAY.PERCIPITATION..Millimeters.","JUNE.PERCIPITATION..Millimeters.")])
df.environment.precipitation$Kharif.percipitation.mm <- rowMeans( df.environment.precipitation[,c("JULY.PERCIPITATION..Millimeters.","AUGUST.PERCIPITATION..Millimeters.","SEPTEMBER.PERCIPITATION..Millimeters.","OCTOBER.PERCIPITATION..Millimeters.")])
df.environment.precipitation$Rabi.percipitation.mm <-rowMeans( df.environment.precipitation[,c("NOVEMBER.PERCIPITATION..Millimeters.","DECEMBER.PERCIPITATION..Millimeters.","JANUARY.PERCIPITATION..Millimeters.","FEBRUARY.PERCIPITATION..Millimeters.")])


#df.environment.temperature.maximum

df.environment.temperature.maximum$Zaid.temp.max.c <- rowMeans(df.environment.temperature.maximum[,c("MARCH.MAXIMUM..Centigrate.","APRIL.MAXIMUM..Centigrate.","MAY.MAXIMUM..Centigrate.","JUNE.MAXIMUM..Centigrate.")])
df.environment.temperature.maximum$Kharif.temp.max.c <- rowMeans(df.environment.temperature.maximum[,c("JULY.MAXIMUM..Centigrate.","AUGUST.MAXIMUM..Centigrate.","SEPTEMBER.MAXIMUM..Centigrate.","OCTOBER.MAXIMUM..Centigrate.")])
df.environment.temperature.maximum$Rabi.temp.max.c <- rowMeans(df.environment.temperature.maximum[,c("NOVEMBER.MAXIMUM..Centigrate.","DECEMBER.MAXIMUM..Centigrate.","JANUARY.MAXIMUM..Centigrate.","FEBRUARY.MAXIMUM..Centigrate.")])

#df.environment.temperature.minimum

df.environment.temperature.minimum$Zaid.temp.min.c <- rowMeans(df.environment.temperature.minimum[,c("MARCH.MINIMUM..Centigrate.","APRIL.MINIMUM..Centigrate.","MAY.MINIMUM..Centigrate.","JUNE.MINIMUM..Centigrate.")])
df.environment.temperature.minimum$Kharif.temp.min.c <- rowMeans(df.environment.temperature.minimum[,c("JULY.MINIMUM..Centigrate.","AUGUST.MINIMUM..Centigrate.","SEPTEMBER.MINIMUM..Centigrate.","OCTOBER.MINIMUM..Centigrate.")])
df.environment.temperature.minimum$Rabi.temp.min.c <- rowMeans(df.environment.temperature.minimum[,c("NOVEMBER.MINIMUM..Centigrate.","DECEMBER.MINIMUM..Centigrate.","JANUARY.MINIMUM..Centigrate.","FEBRUARY.MINIMUM..Centigrate.")])

```

Deleting all other columns ( January to December)

```{r}
library(dplyr)
#dropping all other columns
df.biophysical.monthly.rainfall <- select(df.biophysical.monthly.rainfall,1:3,19:21)
df.environment.evapotranspiration.actual <- select(df.environment.evapotranspiration.actual,1:3,18:20)

df.environment.evapotranspiration.potential <- select(df.environment.evapotranspiration.potential,1:3,18:20)
df.environment.precipitation <- select(df.environment.precipitation,1:3,18:20)
df.environment.temperature.maximum <- select(df.environment.temperature.maximum,1:3,18:20)
df.environment.temperature.minimum <- select(df.environment.temperature.minimum,1:3,18:20)

#TODO
#write code here to delete state name and district name from all the data sets.


```

Now that our datasets are ready, we will try to combine all those data sets to a single DF.

We are going to use $\textbf{joins from dplyr package}$ here. We are going to use full join because we don't want to loose any data. 
we will plan to handle the missing values later.

We are getting lot of rows due to cartesian product. As per discussion with Professor,k decided to move on with join on Year and concentrate on new data first.



```{r}

#TODO
#Complete previous TODO before running this.

combine1 <- full_join(df.rice.area.production.yield,df.rice.farm.harvest.price,by = c("Dist.Code","State.Code","Year"))
combine2 <- full_join(combine1,df.irrigation.sourcewise.irrigated.area,by = c("Dist.Code","State.Code","Year"))
combine3 <- full_join(combine2,df.irrigation.rice.area,by = c("Dist.Code","State.Code","Year"))
combine4 <- full_join(combine3,df.inputs.wages,by = c("Dist.Code","State.Code","Year"))
combine5 <- full_join(combine4,df.inputs.season.fertilizer.consumption,by = c("Dist.Code","State.Code","Year"))
combine6 <- full_join(combine5,df.inputs.fertilizer.consumption,by = c("Dist.Code","State.Code","Year"))
combine7 <- full_join(combine6,df.environment.temperature.minimum,by = c("Dist.Code","State.Code","Year"))
combine8 <- full_join(combine7,df.environment.temperature.maximum,by = c("Dist.Code","State.Code","Year"))
combine9 <- full_join(combine8,df.environment.precipitation,by = c("Dist.Code","State.Code","Year"))
combine10 <- full_join(combine9,df.environment.evapotranspiration.potential,by = c("Dist.Code","State.Code","Year"))
combine11 <- full_join(combine10,df.environment.evapotranspiration.actual,by = c("Dist.Code","State.Code","Year"))
combine12 <- full_join(combine11,df.biophysical.monthly.rainfall,by = c("Dist.Code","State.Code","Year"))
combine13 <- full_join(combine12,df.biophysical.landuse,by = c("Dist.Code","State.Code","Year"))
combine14 <- full_join(combine13,df.biophysical.length.of.growing.period,by = c("Dist.Code","State.Code"))
df.all <- full_join(combine14,df.biophysical.soil.type1,by = c("Dist.Code","State.Code"))

```
Initially, our final dataframe consists of 884 observations with 137 predictors.
But by taking averages of columns season-wise, we reduced predictors from 137 to 82 and 780 observations.


```{r}
#factorising
df.all$Dist.Code <- as.factor(df.all$Dist.Code)
df.all$Year.x <- as.factor(df.all$Year.x)
df.all$State.Code <- as.factor(df.all$State.Code)
#df.all$State.Name <- as.factor(df.all$State.Name)
#df.all$Dist.Name <- as.factor(df.all$Dist.Name)
#df.all$Year <- as.factor(df.all$Year)
#df.all$Year.y <- as.factor(df.all$Year.y)
df.all$LENGTH.OF.GROWING.PERIOD.DAYS..Number. <- as.numeric(df.all$LENGTH.OF.GROWING.PERIOD.DAYS..Number.)

```

summary


```{r}

str(df.all)

summary(df.all)

```



#TODO
#Feature engineering / reduction of predictors


finidng corelation

```{r}
library(caret)
library(corrplot)
corMatrix <- cor(df.all)
corrplot(corMatrix)
```


```{r}
#https://towardsdatascience.com/how-to-create-a-correlation-matrix-with-too-many-variables-309cc0c0a57

corr_simple <- function(data=df.all,sig=0.5){
  #convert data to numeric in order to run correlations
  #convert to factor first to keep the integrity of the data - each value will become a number rather than turn into NA
  df_cor <- data %>% mutate_if(is.character, as.factor)
  df_cor <- df_cor %>% mutate_if(is.factor, as.numeric)
  #run a correlation and drop the insignificant ones
  corr <- cor(df_cor)
  #prepare to drop duplicates and correlations of 1     
  corr[lower.tri(corr,diag=TRUE)] <- NA 
  #drop perfect correlations
  corr[corr == 1] <- NA 
  #turn into a 3-column table
  corr <- as.data.frame(as.table(corr))
  #remove the NA values from above 
  corr <- na.omit(corr) 
  #select significant values  
  corr <- subset(corr, abs(Freq) > sig) 
  #sort by highest correlation
  corr <- corr[order(-abs(corr$Freq)),] 
  #print table
  print(corr)
  #turn corr back into matrix in order to plot with corrplot
  mtx_corr <- reshape2::acast(corr, Var1~Var2, value.var="Freq")
  
  #plot correlations visually
  corrplot(mtx_corr, is.corr=FALSE, tl.col="black", na.label=" ")
}
corr_simple()
```

